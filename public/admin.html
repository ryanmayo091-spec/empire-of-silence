<!DOCTYPE html>
<html>
<head>
  <title>Empire of Silence - Admin Panel</title>
  <link rel="stylesheet" href="style.css">
  <script src="common.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  <div class="sidebar">
    <h2>Empire ğŸ•¶ï¸</h2>
    <a href="/">ğŸ  Home</a>
    <a href="/crimes">ğŸ’€ Crimes</a>
    <a href="/jobs">ğŸ“œ Jobs</a>
    <a href="/login">ğŸ”‘ Login</a>
    <a href="/register">ğŸ“ Register</a>
    <a href="/admin">ğŸ‘‘ Admin</a>
  </div>

  <div class="content">
    <h1>Admin Panel</h1>

    <!-- Players Management -->
    <div class="panel">
      <h2>Players</h2>
      <div id="players">Loading players...</div>
    </div>

    <!-- Role Management -->
    <div class="panel">
      <h2>Roles</h2>
      <p>Promote/demote users.</p>
      <input id="roleUserId" placeholder="User ID">
      <select id="newRole">
        <option value="user">User</option>
        <option value="mod">Mod</option>
        <option value="admin">Admin</option>
        <option value="helper">Helper</option>
      </select>
      <button onclick="updateRole()">Update Role</button>
    </div>
  </div>

  <script>
    // Restrict access if not admin or mod
    if (!(role === "admin" || role === "mod")) {
      document.body.innerHTML = "<h1 style='color:red;text-align:center'>Access Denied</h1>";
      throw new Error("Not authorized");
    }

    async function loadPlayers() {
      const players = await apiGet("/admin/players");

      if (!players || players.length === 0) {
        document.getElementById("players").innerHTML = "<p>No players found.</p>";
        return;
      }

      let html = "<table><tr><th>ID</th><th>Name</th><th>Cash</th><th>Respect</th><th>Heat</th><th>Prison</th><th>Actions</th></tr>";
      players.forEach(p => {
        html += `<tr>
          <td>${p.id}</td>
          <td>${p.name}</td>
          <td>$${p.cash}</td>
          <td>${p.respect}</td>
          <td>${p.heat}</td>
          <td>${p.in_prison_until ? new Date(p.in_prison_until).toLocaleString() : "Free"}</td>
          <td>
            <button onclick="banUser(${p.user_id}, true)">ğŸš« Ban</button>
            <button onclick="banUser(${p.user_id}, false)">âœ… Unban</button>
            <button onclick="giveCash(${p.id}, 500)">ğŸ’µ +500</button>
            <button onclick="giveCash(${p.id}, -500)">ğŸ’¸ -500</button>
          </td>
        </tr>`;
      });
      html += "</table>";
      document.getElementById("players").innerHTML = html;
    }

    async function banUser(userId, banned) {
      const res = await apiPost("/admin/ban", { userId, banned });
      alert(res.message || res.error);
      loadPlayers();
    }

    async function giveCash(playerId, amount) {
      const res = await apiPost("/admin/cash", { playerId, amount });
      alert(res.message || res.error);
      loadPlayers();
    }

    async function updateRole() {
      const userId = document.getElementById("roleUserId").value;
      const newRole = document.getElementById("newRole").value;
      const res = await apiPost("/admin/role", { userId, role: newRole });
      alert(res.message || res.error);
    }

    loadPlayers();
  </script>
</body>
</html>
