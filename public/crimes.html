<!DOCTYPE html>
<html>
<head>
  <title>Empire of Silence - Crimes</title>
  <link rel="stylesheet" href="style.css">
  <script src="common.js"></script>
</head>
<body>
  <div id="app"></div>

  <script>
    if (!token) {
      window.location = "/login";
    } else {
      document.getElementById("app").innerHTML = `
        <div class="sidebar">
          <h2>Empire</h2>
          <a href="/">Home</a>
          <a href="/crimes">Crimes</a>
          <a href="/jobs">Jobs</a>
          <a href="/prison">Prison</a>
          <a href="#" onclick="logout()">Logout</a>
          <a id="adminLink" href="/admin" style="display:none;">Admin</a>
        </div>

        <div class="content">
          <h1>Crimes</h1>
          <div class="panel" id="crimePanel">Loading crimes...</div>
          <div class="panel" id="result"></div>
        </div>
      `;

      const crimeTypes = {
        pickpocket:   { label: "Pickpocket",   minRank: "Street Rat" },
        shoplift:     { label: "Shoplifting",  minRank: "Errand Boy" },
        vandalism:    { label: "Vandalism",    minRank: "Associate" },
        car_theft:    { label: "Car Theft",    minRank: "Muscle" },
        smuggling:    { label: "Smuggling",    minRank: "Enforcer" },
        kidnap:       { label: "Kidnap",       minRank: "Caporegime" },
        blackmail:    { label: "Blackmail",    minRank: "Caporegime" },
        drug_deal:    { label: "Drug Dealing", minRank: "Underboss" },
        hijack_truck: { label: "Hijack Truck", minRank: "Underboss" },
        rob_bank:     { label: "Rob Bank",     minRank: "Consigliere" },
        arms_deal:    { label: "Arms Deal",    minRank: "Consigliere" },
        political_hit:{ label: "Political Hit",minRank: "Boss" },
        legendary_heist:{label: "Legendary Heist", minRank: "Godfather" }
      };

      const ranks = [
        "Street Rat","Errand Boy","Associate","Muscle","Enforcer",
        "Caporegime","Underboss","Consigliere","Boss","Godfather"
      ];

      apiGet("/players/me").then(p => {
        buildCrimeButtons(p.rank);

        if (p.in_prison_until) {
          startPrisonCountdown(new Date(p.in_prison_until).getTime(), p.cash);
          lockCrimes();
        }

        if (role === "admin" || role === "mod") {
          document.getElementById("adminLink").style.display = "block";
        }
      });

      function buildCrimeButtons(playerRank) {
        let html = `<p>Select a crime to commit. Locked crimes show their required rank.</p>`;
        Object.entries(crimeTypes).forEach(([key, crime]) => {
          const isUnlocked = ranks.indexOf(playerRank) >= ranks.indexOf(crime.minRank);
          html += `
            <button class="crime-btn" id="btn-${key}" ${isUnlocked ? `onclick="doCrime('${key}')"` : "disabled"}
              title="${isUnlocked ? "" : "Unlocks at " + crime.minRank}">
              ${crime.label} ${isUnlocked ? "" : `(${crime.minRank}+)`}
            </button><br>
          `;
        });
        document.getElementById("crimePanel").innerHTML = html;
      }

      async function doCrime(type) {
        const res = await apiPost("/crimes", { type });
        if (res.error) {
          document.getElementById("result").innerHTML = `<p class="crime-fail">${res.error}</p>`;
        } else {
          let cssClass = "crime-info";
          if (res.message.includes("Success")) cssClass = "crime-success";
          else if (res.message.includes("Failed")) cssClass = "crime-fail";
          else if (res.message.includes("ranked")) cssClass = "crime-rankup";
          else if (res.message.includes("Prestiged")) cssClass = "crime-prestige";

          document.getElementById("result").innerHTML = `<p class="${cssClass}">${res.message}</p>`;

          if (res.message.includes("prison for")) {
            lockCrimes();
            const p = await apiGet("/players/me");
            startPrisonCountdown(new Date(p.in_prison_until).getTime(), p.cash);
          }
        }
      }

      function lockCrimes() {
        document.querySelectorAll(".crime-btn").forEach(btn => {
          btn.disabled = true;
        });
      }

      function unlockCrimes() {
        document.querySelectorAll(".crime-btn").forEach(btn => {
          if (!btn.title.startsWith("Unlocks")) btn.disabled = false;
        });
      }

      function startPrisonCountdown(prisonEnd, cash) {
        const interval = setInterval(() => {
          const now = Date.now();
          const diff = prisonEnd - now;

          if (diff <= 0) {
            clearInterval(interval);
            document.getElementById("result").innerHTML = `<p class="crime-success">You are free from prison.</p>`;
            unlockCrimes();
          } else {
            const mins = Math.floor(diff / 60000);
            const secs = Math.floor((diff % 60000) / 1000);
            const bailCost = mins * 100;

            document.getElementById("result").innerHTML = `
              <p class="crime-fail">In prison for ${mins}m ${secs}s...</p>
              <button onclick="payBail(${bailCost})" ${cash < bailCost ? "disabled" : ""}>
                Pay Bail ($${bailCost})
              </button>
            `;
          }
        }, 1000);
      }

      async function payBail(cost) {
        const res = await apiPost("/prison/bail", {});
        if (res.error) {
          alert(res.error);
        } else {
          alert(res.message);
          location.reload();
        }
      }
    }
  </script>
</body>
</html>
