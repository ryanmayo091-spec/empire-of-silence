<!DOCTYPE html>
<html>
<head>
  <title>Empire of Silence - Crimes</title>
  <link rel="stylesheet" href="style.css">
  <script src="common.js"></script>
</head>
<body>
  <div id="app"></div>

  <script>
    if (!token) {
      // Not logged in → send to login
      window.location = "/login";
    } else {
      document.getElementById("app").innerHTML = `
        <div class="sidebar">
          <h2>Empire</h2>
          <a href="/">🏠 Home</a>
          <a href="/crimes">💀 Crimes</a>
          <a href="/jobs">📜 Jobs</a>
          <a href="#" onclick="logout()">🚪 Logout</a>
          <a id="adminLink" href="/admin" style="display:none;">👑 Admin</a>
        </div>

        <div class="content">
          <h1>Crimes</h1>
          <div class="panel" id="crimePanel">Loading crimes...</div>
          <div class="panel" id="result"></div>
        </div>
      `;

      const crimeTypes = {
        pickpocket:   { label: "Pickpocket",   minRank: "Street Rat" },
        shoplift:     { label: "Shoplifting",  minRank: "Errand Boy" },
        vandalism:    { label: "Vandalism",    minRank: "Associate" },
        car_theft:    { label: "Car Theft",    minRank: "Muscle" },
        smuggling:    { label: "Smuggling",    minRank: "Enforcer" },
        kidnap:       { label: "Kidnap",       minRank: "Caporegime" },
        blackmail:    { label: "Blackmail",    minRank: "Caporegime" },
        drug_deal:    { label: "Drug Dealing", minRank: "Underboss" },
        hijack_truck: { label: "Hijack Truck", minRank: "Underboss" },
        rob_bank:     { label: "Rob Bank",     minRank: "Consigliere" },
        arms_deal:    { label: "Arms Deal",    minRank: "Consigliere" },
        political_hit:{ label: "Political Hit",minRank: "Boss" },
        legendary_heist:{label: "Legendary Heist", minRank: "Godfather" }
      };

      const ranks = [
        "Street Rat","Errand Boy","Associate","Muscle","Enforcer",
        "Caporegime","Underboss","Consigliere","Boss","Godfather"
      ];

      // Load player rank
      apiGet("/players/me").then(p => {
        const playerRank = p.rank;
        let html = `<p>Select a crime to commit. Locked crimes show their required rank.</p>`;

        Object.entries(crimeTypes).forEach(([key, crime]) => {
          const isUnlocked = ranks.indexOf(playerRank) >= ranks.indexOf(crime.minRank);
          html += `
            <button id="btn-${key}" ${isUnlocked ? `onclick="doCrime('${key}')"` : "disabled"}
              title="${isUnlocked ? "" : "Unlocks at " + crime.minRank}">
              ${crime.label} ${isUnlocked ? "" : `(${crime.minRank}+)`}
            </button><br>
          `;
        });

        document.getElementById("crimePanel").innerHTML = html;

        if (role === "admin" || role === "mod") {
          document.getElementById("adminLink").style.display = "block";
        }
      });

      async function doCrime(type) {
        const res = await apiPost("/crimes", { type });
        if (res.error) {
          document.getElementById("result").innerHTML = `<p style="color:red">${res.error}</p>`;
        } else {
          document.getElementById("result").innerHTML = `<p>${res.message}</p>`;
          // Optional: refresh stats dynamically
          refreshStats();
        }
      }

      // Fetch and update stats on the sidebar/dashboard if needed
      async function refreshStats() {
        const p = await apiGet("/players/me");
        console.log("Updated player:", p); // dev debug
      }
    }
  </script>
</body>
</html>
